---
title: "A time-in time-out model"
author: "Anders Poulsen Charmouth, Brad Duthie"
date: "02 January 2022"
output: pdf_document
bibliography: refs.bib
---


Model
================================

We use a time-in and time-out model in which females and males spend some period of time searching for a mate (time-in) followed by a period of cool down outside the mating pool (time-out).

After mating, we assume that females must spend some time processing offspring ($T_{f}$). Male time to replenish sperm is negligible, but males can spend time out of the mating pool to search for a nuptial gift. When males return from time out, they encounter females with some probability that is a function of the encounter rate between opposite sex conspecifics ($M$) and the sex ratio ($\beta$; males:females). Mortality occurs for females in ($\mu_{if}$) and out ($\mu_{of}$) of the mating pool, and for males in ($\mu_{im}$) and out ($\mu_{om}$) of the mating pool. First, we describe the fitness consequences of male search time for a nuptial gifts. We then describe the fitness consequences of female choice to accept or reject males based on their provision of a nuptial gift. 

```{r, echo = FALSE}
calc_beta <- function(M = 1, TF = 1, TM = 1){
  term1 <-   (M * (TF - TM))^2;
  term2 <-   (M * (TF - TM))^4;
  term3 <- 4*(M * (TF - TM))^2;
  ttrm  <- (term2 + term3)^(1/2);
  sol1  <- 0.5 * (term1 - ttrm) + 1;
  sol2  <- 0.5 * (term1 + ttrm) + 1;
  if(TF > TM){
    beta = max(c(sol1, sol2));
  }else{
    beta = min(c(sol1, sol2));
  }
  return(list = c(beta = beta, solution1 = sol1, solution2 = sol2));
}
get_beta <- function(M = 1, TF = 1, TM = 1){
  betas <- rep(NA, length = length(TM));
  for(i in 1:length(TM)){
    betas[i] <- calc_beta(M = M, TF = TF, TM = TM[i])[[1]];
  }
  return(betas);
}
```


Male fitness
----------------------------

During time-out, males search for a nuptial gift for a time period of $T_{m}$. Initially, we assume that males must spend the full $T_{m}$ in the time-out phase, even if they succeed in finding a nuptial gift. The probability that a male obtains a true nuptial gift ($G$) during this time is modelled as,

$$\Pr(G) = 1 - e^{-\frac{1}{\alpha_{1}}T_{m}}.$$
```{r, echo = FALSE}
PrGf <- function(Tm, a1){
  vals <- 1 - exp(-(1/a1)*Tm);
  return(vals);
}
```


In the above, $\alpha_{1}$ is the amount of time expected to pass before a male encounters a nuptial gift. We assume that a male will only enter the mating pool with no gift if they are unsuccessful in obtaining gift, so the probability that a male obtains no gift after $T_{m}$ is modelled as,

```{r, echo = FALSE}
PrFf <- function(Tm, a1, a2 = Inf){
  vals <- (1 - exp(-(1/a2)*Tm)) * exp(-(1/a1)*Tm);
  return(vals);
}
```



$$\Pr(L) = e^{-\frac{1}{\alpha_{1}}T_{m}}.$$

```{r, echo = FALSE}
PrLf <- function(Tm, a1, a2 = Inf){
  vals <- exp(-((1/a1) + (1/a2))*Tm);
  return(vals);
}
```

For simplicity, we assume that the fitness increments to offspring associated with nuptial gift versus no nuptial gift are $V_{G} = 1 + \gamma$ and $V_{L} = 1$, respectively. The rate at which males increase their fitness can then be defined as the expected fitness increment from their nuptial gift search divided by $T_{m}$ plus the time spent in the mating pool waiting to encounter a mate,


$$W_{m} = \frac{\Pr(G)(1 + \gamma) + \Pr(L)}{T_{m} + \frac{\sqrt{\beta}}{M}}.$$

```{r, echo = FALSE}
W_mf <- function(PrG, PrF, PrL, gamma, Tm, beta, M){
  val <- ((PrG * (1 + gamma)) + PrF + PrL) / (Tm + (sqrt(beta)/M));
  return(val);
}
W_mf_full  <- function(gamma, Tm, beta_val, M, a1, a2){
  PrG_val  <- PrGf(Tm = Tm, a1 = a1);
  PrF_val  <- PrFf(Tm = Tm, a1 = a1, a2 = a2);
  PrL_val  <- PrLf(Tm = Tm, a1 = a1, a2 = a2);
  W_mf_val <- W_mf(PrG = PrG_val, PrF = PrF_val, PrL = PrL_val, Tm = Tm, 
                   gamma = gamma, beta = beta_val, M = M);
  return(W_mf_val);
}
```

Our objective now is to determine the conditions under which a focal male increases its fitness by searching for a nuptial gift ($T_{m} > 0$) in a population of resident males that do not search ($T_{m} = 0$).

Initial conditions for nuptial gift-giving
----------------------------

We assume that the ancestral condition is one in which no nuptial gifts are sought by males (i.e., $T_{M} = 0$) and females therefore exhibit no choice in males with or without nuptial gifts. Under such conditions, male fitness cannot be affected by female choice, so selection to increase $T_{M} > 0$ must be based solely on $\alpha_{1}$, $\beta$, $M$, $\gamma$, $m_{im}$, and $m_{om}$. For simplicity, and following @Kokko2006b, we assume $m_{im} = m_{om} = 1$. This leaves $M$, $\alpha_{1}$, $\beta$, and $\gamma$.

Ignoring the recursion for now and just letting $\beta = 1$ (equal sex ratio in time-in stage), we can move on to seeing how fitness changes with a change in $T_{M}$.

The first question that we want to ask is under what conditions does male inclusive fitness increase with nuptial gift search time?  We can determine this by differentiating $W_{m}$ with respect to $T_{m}$,

```{r, echo = FALSE}
W_m  <- function(mom = 1, mim = 1, mof = 1, mif = 1, M = 100, TF, TM, gamma, 
                 a1, a2, beta = 1){
  bb <- beta;
  WW <- W_mf_full(gamma = gamma, Tm = TM, beta_val = bb, M = M, a1 = a1, 
                  a2 = a2);
  return(WW)
}
```
  

<!--- Mathomatic code

W = (( (1 - e^(-(T/a))) * (G + 1) ) + ( (1 - (e^(-T/b)) ) * (e^(-T/a)) ) + ( e^(-T*((1/a) + (1/b))) ))  /   (T + ((B^(1/2))/M))

Assume beta = 1

--->

<!--- 

Why did we get this equation at some point? It appears to be wrong?

$$\frac{\partial W_{m}}{\partial T_{m}} = \frac{M^{2} \left(\gamma e^{\frac{T_{M}}{\alpha_{1}}} - \gamma - 1\right)}{\left(\sqrt{\beta} + T_{M}M \right)^2}.$$

--->


$$\frac{\partial W_{m}}{\partial T_{m}} = \frac{\gamma \left(\frac{\left(\frac{\left(T_{M} + \frac{\sqrt{\beta}}{M} \right)}{\alpha_{1}} + 1 \right)}{e^{\frac{1}{\alpha_{1}}T_{M}}} - 1 \right) - 1}{\left(T_{M} + \frac{\sqrt{\beta}}{M} \right)^{2}}.$$

<!---

0 = ( (G * ((((T + ((B^(1/2))/M)) / a) + 1) /(e^(T/a)) - 1)) - 1) / ((T + ((B^(1/2))/M))^2)

--->


```{r, echo = FALSE}
dWdT <- function(gamma, Tm, beta = 1, M = 100, a1 = 1){
  num1 <- gamma * (M*M + ((M*M*Tm + M*sqrt(beta))/a1) );
  dem1 <- exp((1/a1)*Tm);
  num2 <- (num1 / dem1) - M*M*(1 + gamma);
  den2 <- ((Tm * M) + sqrt(beta))^2;
  val  <- num2/den2;
  return(val);
}
```

<!---

Evaluate at Tm = 0.

D = (G * (M^(2) + ((M * (B^(1/2))) / a)) - (M^(2) * (1 + G))) / B

--->


If we assume an initial condition in which $T_{M} = 0$ (i.e., a population in which males do not search for nuptial gifts at all) and evaluate accordingly, then the above simplifies,

$$\frac{\partial W_{m}}{\partial T_{m}} = \frac{\gamma M}{\alpha_{1}\sqrt{\beta}} - \frac{M^{2}}{\beta}.$$
```{r, echo = FALSE}
dWdT_check <- function(gamma, beta = 1, M = 100, a1 = 1){
  term1 <- (gamma * M) / (a1*sqrt(beta));
  term2 <- (M*M) / beta;
  val   <- term1 - term2;
  return(val);
}
```

The above equation makes intuitive sense. First note, trivially, that if the interaction rate is $M = 0$, then no change in fitness occurs (since females and males cannot mate). The change in fitness caused by searching for nuptial gifts is increased when $\gamma$ is high, scaled by the search time needed to find a nuptial gift (recall that $Pr(G)$ decreases with increasing $\alpha_{1}$). From this first term, a second term is subtracted that reflects a loss in fitness proportional to the encounter rate of potential mates in the mating pool. We can identify the conditions under which male inclusive fitness increases by searching for a nuptial gift by setting $\partial W_{m} / \partial T_{m} = 0$ and solving for $\gamma$, 

$$\gamma_{m} > \alpha_{1}\frac{M}{\sqrt{\beta}}.$$

Verbally, the inclusive fitness benefit to offspring provided by the nuptial gift must exceed the search time needed to find a nuptial gift ($\alpha_{1}$) times the male mate encounter rate ($M / \sqrt{\beta}$). Hence, we should expect nuptial gift giving to evolve when the fitness benefit of the nuptial gift to offspring is high relative to the time needed to find a nuptial gift and the encounter rate of females and males in the mating pool. Note that if we want to generalise for some baseline fitness $\lambda$, instead of assuming $\lambda = 1$, then,

$$\gamma_{m} > \lambda\alpha_{1}\frac{M}{\sqrt{\beta}}.$$

An alternative for male gift giving
-------------------------------------

Up until now, we have assumed that males invest a fixed amount of time $T_{m}$ in the time-out phase searching for nuptial gifts. While this simplifying assumption is unlikely to be problematic for determining the initial evolution of nuptial gift searching behaviour ($\partial W_{m} / \partial T_{m}$), it might not reflect the strategy of males in real systems. For example, instead of spending a fixed amount of time in time-out phase, males might instead to select one of two strategies; either search or do not search for a nuptial gift. Males with the former strategy might simply continue to search until a nuptial gift is found, while males that do not search will simply re-enter the mating pool. In this case, time searching for a nuptial gift will come at the cost of mating opportunities, but might increase the fitness of offspring. We therefore need to model the expected length of time $E[T_{m}]$ spent outside of the mating pool for males that search for nuptial gifts, which is simply $\alpha_{1}$. Note that we can integrate search time $t$ over the rate at which nuptial gifts are encountered ($\exp(-1/\alpha_{1})$) to show $E[T_{m}] = \alpha_{1}$,

$$\int_{0}^{\infty}e^{- \frac{1}{\alpha_{1}}t}dt = \alpha_{1}.$$

The rate at which a focal male that searches for a nuptial gift increases his fitness is therefore fitness of offspring $(1 + \gamma)$ divided by expected time spent searching for a nuptial gift ($\alpha_{1}$) plus time spent in the mating pool ($\sqrt{\beta} / M$),

$$W_{m,G} = \frac{1 + \gamma}{\alpha_{1} + \left(\frac{\sqrt{\beta}}{M} \right)}.$$

In contrast, a male that does not search for a nuptial gift has offspring with lower fitness, but spends less time outside of the mating pool,

$$W_{m,L} = \frac{1}{\left(\frac{\sqrt{\beta}}{M}\right)} = \frac{M}{\sqrt{\beta}}.$$

We can then determine the conditions for which $W_{m,G} > W_{m,L}$, isolating $\gamma$ to find how large of a fitness benefit must be provided by the nuptial gift to make the search cost worthwhile,

$$\gamma_{m} > \alpha_{1}\frac{M}{\sqrt{\beta}}.$$

Recall that this is the exact same inequality that we obtained when assuming the initial condition $T_{M} = 0$ and evaluating $\partial W_{m} / \partial T_{m}$. If $M = 1$ and $\beta = 1$, then we get the elegant $\gamma > \alpha_{1}$. That is, the inclusive fitness increase must be greater than the time spent searching for a nuptial gift. As the interaction rate $M$ increases, the fitness benefit must be even higher to compensate for the opportunity cost of being able to enter the mating pool early by not searching for a nuptial gift.



Female fitness
----------------------------

During time-out, females process offspring over a duration of $T_{f}$ (we assume that $T_{f} > \alpha_{1}$, else females are no longer the choosy sex). When females re-enter the mating pool, they will then encounter males at a rate of $M\sqrt{\beta}$. We assume that female offspring receive a fitness increment of $\gamma \geq 0$ from males that provide a true nuptial gift. Female fitness therefore never decreases by mating with a male with a nuptial gift versus a male without one. Therefore, if a female encounters a male with a nuptial gift, we assume that she will mate with him. But if a female encounters a male with no nuptial gift, then she might accept or reject the male. If she rejects the male, then she will remain in the mating pool. We model the probability that a female encounters a male with a nuptial gift after a duration of $T_{N}$ in the mating pool as,

$$\Pr(g) = 1 - e^{-T_{N}\left( M \sqrt{\beta}\right) \Pr(G)}.$$

We can similarly model the probability that a female encounters a giftless male after $T_{N}$ as,

$$\Pr(n) = 1 - e^{-T_{N} (M \sqrt{\beta}) \Pr(L)}.$$

Note that $\Pr(g)$ and $\Pr(n)$ need not sum to unity, and if $\Pr(L)$ is sufficiently low, then finding a male with a gift will be easier than finding a male without one (i.e., $\Pr(g) > \Pr(n)$). Also note that the expected time spent in the mating pool before a focal female encounters a male with a gift will be $1 / (\Pr(G) \times M \sqrt{\beta})$, while the expected time spent in the mating pool before a focal female encounters any male will be $1 / (M \sqrt{\beta})$ (since $\Pr(G) + \Pr(L) = 1$). We can use this to determine the rate at which a female increases her fitness when she is choosy and mates only with males that have gifts versus when she is not choosy and mates with the first male she encounters. The rate at which a female increases her fitness by being choosy and mating only when she encounters a male with a gift is as follows,

$$W_{f}(g) = \frac{1 + \gamma}{T_{F} + \left(\frac{1}{\Pr(G) \times M \sqrt{\beta}}\right)}.$$

If the focal female is not choosy and accepts the first male that she encounters, then the rate at which she increases her fitness is as follows,

$$W_{f}(n) = \frac{\left(1 + \gamma \right) \Pr(G) + \Pr(L)}{T_{F} + \left(\frac{1}{M \sqrt{\beta}}\right)}.$$

We can now ask a relevant question for female fitness. Under what conditions should she be choosy and only accept males with nuptial gifts? To answer this question, we can evaluate the conditions under which $W_{f}(g) > W_{f}(n)$,

$$\gamma_{f} > \frac{e^{\frac{1}{\alpha_{1}}T_{M}}}{T_{F}M\sqrt{\beta}   \left(e^{\frac{1}{\alpha_{1}}T_{M}} - 1   \right)  }.$$

<!---

(1 + G) / (F + ((1 / ( (1 - e^(-T/a))  * M * (B^(1/2)))  ))) = ((1 + G)*(1 - e^(-T/a)) + (e^(-T/a)) ) / (F + ((1 / (M * (B^(1/2)))  )))


(L + G) / (F + ((1 / ( (1 - e^(-T/a))  * M * (B^(1/2)))  ))) = ((L + G)*(1 - e^(-T/a)) + (e^(-T/a)) ) / (F + ((1 / (M * (B^(1/2)))  )))

--->

Under the above conditions in which the fitness increase caused by the nuptial gift is sufficiently high, females will increase their own fitness by rejecting males that do not have a nuptial gift. Note that if we want to generalise for some baseline fitness $\lambda$, instead of assuming $\lambda = 1$, then,

$$\gamma_{f} > 1 - \lambda + \frac{e^{\frac{1}{\alpha_{1}}T_{M}}}{T_{F}M\sqrt{\beta}   \left(e^{\frac{1}{\alpha_{1}}T_{M}} - 1   \right)  }.$$

Operational sex ratio
----------------------------

We assume that the sex ratio at maturation is unity (i.e., equal number of males and females upon maturation). Under this condition, @Kokko2001 show that the operational sex ratio depends on the probability of finding an individual in 'time in',

$$\beta = \frac{\int_{t = 0}^{\infty} P_{IM}(t)dt}{\int_{t = 0}^{\infty} P_{IF}(t)dt}.$$

In the above, $P_{IM}(t)$ and $P_{IF}(t)$ are the probabilities of finding a male and female in 'time in', respectively. @Kokko2001 find these probabilities in terms of the cost of mating. For our purpose, we can find the probability of find a male in 'time in' as the time spent in the mating pool waiting to encounter females ($\sqrt{\beta} / M$) divided by total time in and out,

$$P_{IM}(t) = \frac{\left(\frac{\sqrt{\beta}}{M}\right)}{T_{M} + \left(\frac{\sqrt{\beta}}{M}\right)}.$$


We can define $P_{IF}(t)$ similarly,

$$P_{IF}(t) = \frac{ \left( \frac{1}{M\sqrt{\beta}} \right)  }{ T_{F} + \left( \frac{1}{M\sqrt{\beta}} \right)}.$$


We therefore can define $\beta$ as below,

$$\beta = \frac{\left(\frac{\left(\frac{\sqrt{\beta}}{M}\right)}{T_{M} + \left(\frac{\sqrt{\beta}}{M}\right)}\right)}{\left(\frac{ \left( \frac{1}{M\sqrt{\beta}} \right)  }{ T_{F} + \left( \frac{1}{M\sqrt{\beta}} \right)}\right)}.$$


The above can be simplified,

$$\beta = \frac{\beta T_{F} M + \sqrt{\beta}}{T_{M}M + \sqrt{\beta} }.$$

A closed form solution for the above equation can be found,

$$\beta = \frac{1}{2}\left(\left(M \left( T_{F} - T_{M} \right)\right)^{2} \pm \left(\left(M \left(T_{F} - T_{M} \right) \right)^{4} + 4 \left(M \left(T_{F} - T_{M} \right)\right)^{2} \right)^\frac{1}{2}\right) + 1.$$

We can use this solution to define $\beta$ in terms of $M$, $T_{F}$, and $T_{M}$. Note that there are two solutions to $\beta$, but when $T_{M} > T_{F}$, then $\beta > 1$, and when $T_{M} < T_{F}$, then $\beta < 1$ (if $T_{M} = T_{F}$, then $\beta = 1$).

```{r, echo = FALSE}
calc_beta <- function(M = 1, TF = 1, TM = 1){
  term1 <-   (M * (TF - TM))^2;
  term2 <-   (M * (TF - TM))^4;
  term3 <- 4*(M * (TF - TM))^2;
  ttrm  <- (term2 + term3)^(1/2);
  sol1  <- 0.5 * (term1 - ttrm) + 1;
  sol2  <- 0.5 * (term1 + ttrm) + 1;
  if(TF > TM){
    beta = max(c(sol1, sol2));
  }else{
    beta = min(c(sol1, sol2));
  }
  return(list = c(beta = beta, solution1 = sol1, solution2 = sol2));
}
```

<!---


This has two solutions,

$$\beta = \frac{1}{2} \left(\left(\left(M\left(T_{F} - T_{M}\right)\right)^{4} + 4\left(M\left(T_{F} - T_{M}\right) \right)^{2} \right)^{\frac{1}{2}} + \left(M\left(T_{F} - T_{M}\right)\right)^{2}\right) + 1$$

And

$$\beta = \frac{1}{2}\left(\left(M \left( T_{F} - T_{M} \right)\right)^{2} - \left(\left(M \left(T_{F} - T_{M} \right) \right)^{4} + 4 \left(M \left(T_{F} - T_{M} \right)\right)^{2} \right)^\frac{1}{2}\right) + 1.$$
--->

<!---

$$\beta = \frac{T_{F}\sqrt{\beta} + \beta M}{T_{M}\beta^{2}\sqrt{M} + \beta M}.$$

--->



Male nuptial search and female choosiness
-------------------------------------------

We can now investigate the values of $\gamma_{m}$ and  $\gamma_{f}$ across parameter space. First, we look across values of $\alpha_{1}$ given fixed values of  $M = 1$, and $T_{F} = 2$. Note that expected male search time for a nuptial gift will be $T_{M} = \alpha_{1}$, meaning that $\exp(T_{m} / \alpha_{1}) = e$.

```{r, echo = FALSE}
gamma_m <- function(M = 1, beta = 1, alpha = 1/16, TF = 2){
  return(alpha * (M / sqrt(beta)));
}
```

```{r, echo = FALSE}
gamma_f <- function(M = 1, beta = 1, alpha = 1/16, TF = 2){
  topp <- exp(alpha / alpha);
  bott <- TF * M * sqrt(beta) * (exp(alpha/alpha) - 1);
  return(topp/bott);
}
```


```{r, echo = FALSE, fig.cap = "Parameter space in which males do not search for nuptial gifts and females are not choosy (A), males search but females are not choosy (B), females would be choosy but males do not search (C), and males search and females are choosy (D)."}
alpha_vals <- seq(from = 0.0001, to = 1.2, by = 0.0001);
par(mar = c(5, 5, 1, 1));
beta_vals <- get_beta(M = 1, TF = 2, TM = alpha_vals);
g_m <- gamma_m(M = 1, beta = beta_vals, alpha = alpha_vals, TF = 2);
g_f <- gamma_f(M = 1, beta = beta_vals, alpha = alpha_vals, TF = 2);
plot(x = alpha_vals, y = g_m, type = "l", lwd = 2, cex.lab = 1.25,
     xlab = expression(paste("Nuptial gift search time (", alpha[1], ")")),
     ylab = expression(paste("Fitness threshold (", gamma, ")")),
     ylim = c(0, 1.5));
points(x = alpha_vals, y = g_f, type = "l", lwd = 2, cex.lab = 1.25,
     col = "black", lty = "solid");
g_v <- which(g_f > g_m);
g_w <- which(g_f <= g_m);
polygon(x = c(alpha_vals[g_v], rev(alpha_vals[g_v])), 
        y = c(g_m[g_v], rev(g_f[g_v])),
        border = NA, col = "grey70");
polygon(x = c(alpha_vals[g_w], rev(alpha_vals[g_w])), 
        y = c(g_m[g_w], rev(g_f[g_w])),
        border = NA, col = "grey20");
bott <- rep(0, times = length(alpha_vals));
topp <- c(g_m[g_v], g_f[g_w]);
polygon(x = c(alpha_vals, rev(alpha_vals)), 
        y = c(topp, rev(bott)),
        border = NA, col = "grey90");
points(x = alpha_vals, y = g_m, type = "l", lwd = 2, cex.lab = 1.25);
points(x = alpha_vals, y = g_f, type = "l", lwd = 2, cex.lab = 1.25);
text(x = 0.95, y = 0.2, cex = 3, labels = "A");
text(x = 0.15, y = 0.2, cex = 2, labels = "B");
text(x = 1.15, y = 0.65, cex = 2, labels = "C", col = "white");
text(x = 0.4, y = 1, cex = 4, labels = "D");
```

In Figure 1, $\gamma_{m}$ and  $\gamma_{f}$ values are indicated by the sloping and horizontal lines, respectively, which divide the plot into four distinct zones (A-D). In zone A, $\gamma$ is too low relative to $\alpha_{1}$ for males to benefit from searching for nuptial gifts, and too low for females to benefit by being choosy. In zone B, $\gamma$ is sufficiently high relative to $\alpha_{1}$ for males to benefit from searching, but females do not benefit from being choosy. In zone C, males do not benefit from searching for nuptial gifts, but females would benefit from being choosy. Lastly, in zone D, we expect males to benefit from searching for nuptial gifts and for females to benefit by choosing only males that offer nuptial gifts. Note that it is tempting to suggest that zone C is where we might expect male searching for fake nuptial gifts to evolve, but in this zone, no males actually benefit from procuring a nuptial gift. Hence, nuptial gifts should be only fake in zone C, eroding the benefit of female choosiness. Consequently, we could conclude that fake nuptial gift giving should evolve and persist only in zone D, with subsequent effects on $\beta$ (due to more males being in time out) that might affect $\gamma_{f}$.

If we increase $M$ to a value of $M = 2$, then the slope at which $\gamma_{m}$ increases with increasing $\alpha_{1}$ increases, and the value of $\gamma_{f}$ decreases. The increased rate of interaction between females and males effectively decreases the area of parameter space in which males benefit from searching for nuptial gifts but females do not benefit from choosiness, and it increases the area of parameter space in which males benefit from searching and females benefit from being choosy. As $M$ increases further, zone B becomes smaller and zone C becomes larger, as the increased mating rate simultaneously increases the opportunity cost of males that search for nuptial gift and decreases the cost of female choosiness. Increasing $T_{F}$, however, does not affect the slope of $\gamma_{m}$ with $\alpha_{1}$, but it does lower $\gamma_{f}$, thereby increasing the size of zone D.

```{r, echo = FALSE, fig.cap = "Areas of parameter space in which males do not search for nuptial gifts and females are not choosy (A), males search but females are not choosy (B), females would be choosy but males do not search (C), and males search and females are choosy (D). Arrows indicate the effect of increasing interaction rate (M) and female time-out (T_F)"}
alpha_vals <- seq(from = 0.0001, to = 1.2, by = 0.0001);
par(mar = c(5, 5, 1, 1));
beta_vals <- get_beta(M = 1, TF = 2, TM = alpha_vals);
g_m <- gamma_m(M = 2, beta = beta_vals, alpha = alpha_vals, TF = 2);
g_f <- gamma_f(M = 2, beta = beta_vals, alpha = alpha_vals, TF = 2);
plot(x = alpha_vals, y = g_m, type = "l", lwd = 2, cex.lab = 1.25,
     xlab = expression(paste("Nuptial gift search time (", alpha[1], ")")),
     ylab = expression(paste("Fitness threshold (", gamma, ")")),
     ylim = c(0, 1.5), col = "black");
points(x = alpha_vals, y = g_f, type = "l", lwd = 2, cex.lab = 1.25,
     col = "black", lty = "solid");
g_v <- which(g_f > g_m);
g_w <- which(g_f <= g_m);
polygon(x = c(alpha_vals[g_v], rev(alpha_vals[g_v])), 
        y = c(g_m[g_v], rev(g_f[g_v])),
        border = NA, col = "grey70");
polygon(x = c(alpha_vals[g_w], rev(alpha_vals[g_w])), 
        y = c(g_m[g_w], rev(g_f[g_w])),
        border = NA, col = "grey20");
bott <- rep(0, times = length(alpha_vals));
topp <- c(g_m[g_v], g_f[g_w]);
polygon(x = c(alpha_vals, rev(alpha_vals)),
        y = c(topp, rev(bott)),
        border = NA, col = "grey90");
points(x = alpha_vals, y = g_m, type = "l", lwd = 2, cex.lab = 1.25,
       col = "blue");
points(x = alpha_vals, y = g_f, type = "l", lwd = 2, cex.lab = 1.25,
       col = "red");
text(x = 0.8, y = 0.1, cex = 2, labels = "A");
text(x = 0.02, y = 0.1, cex = 1, labels = "B");
text(x = 1, y = 0.7, cex = 4, labels = "C", col = "white");
text(x = 0.2, y = 1.1, cex = 5, labels = "D");
arrows(x0 = alpha_vals[8500], x1 = alpha_vals[7800], col = "blue",
       y0 = g_m[8500], y1 = 1.2, length = 0.1, lwd = 2);
text(x = alpha_vals[7550], y = 1.27, labels = "M", col = "blue");
arrows(x0 = alpha_vals[5000], x1 = alpha_vals[5000], col = "red",
       y0 = g_f[5000], y1 = 0.1, length = 0.1, lwd = 2);
text(x = alpha_vals[5000], y = 0.05, labels = "M", col = "red");
arrows(x0 = alpha_vals[4000], x1 = alpha_vals[4000], col = "red",
       y0 = g_f[4000], y1 = 0.1, length = 0.1, lwd = 2);
text(x = alpha_vals[4000], y = 0.05, labels = expression(T[F]), col = "red");
# Make an arrow perpendicular to the slope indicating effect of M
# Arrow goes down to indicate what happens for gamma_f with M
# Arrow goes down to indicate what happens for gamma_f with TF
```





Evolution of nuptial gift giving
----------------------------

```{r, echo = FALSE}
Wp <- function(M, beta, Tm, a1, gamma){
  topp <- gamma * ((((Tm + (sqrt(beta)/M)) / a1) + 1) /(exp(Tm/a1)) - 1) - 1;
  bott <- (Tm + sqrt(beta)/M)^2
  val  <- topp / bott;
  return(val);
}

Wpp <- function(M, beta, Tm, a1, gamma){
    top1  <- 1 + (((sqrt(beta)/M) + Tm) / a1);
    bot1  <- exp(Tm/a1);
    topp2 <- 2 * (1 + gamma*(1 - top1 / bot1));
    bott2 <- (Tm + (sqrt(beta)/M))^2;
    term2 <- gamma / ((a1*a1)*exp(Tm/a1));
    bott  <- Tm + sqrt(beta)/M;
    val   <- ((topp2 / bott2) - term2) / bott;
    return(val);
}
```


<!---

0 = ( (G * ((((T + ((B^(1/2))/M)) / a) + 1) /(e^(T/a)) - 1)) - 1) / ((T + ((B^(1/2))/M))^2)


0 = ( ((1/2) * ((((T + ((1^(1/2))/1)) / (1/16)) + 1) /(e^(T/(1/16))) - 1)) - 1) / ((T + ((1^(1/2))/1))^2)

--->



```{r, echo = FALSE}
findWpmin <- function(M, beta, a1, gamma, b0, b1){
  bynum   <- ((b1 + b0)/2 - b0) / 1000;
  TMvals1 <- seq(from = b0, to = (b1 + b0)/2, by = bynum);
  TMvals2 <- seq(from = (b1 + b0)/2, to = b1, by = bynum);
  abm     <- 10000;
  while(bynum > 0 & abm > 0.0001){
      ab1 <- abs(Wp(M = M, beta = beta, Tm = TMvals1, a1 = a1, gamma = gamma));
      ab2 <- abs(Wp(M = M, beta = beta, Tm = TMvals2, a1 = a1, gamma = gamma));
      mn1 <- min(ab1);
      mn2 <- min(ab2);
      abm <- min(c(mn1, mn2));
      if(mn1 < mn2){
          b1  <- (b1 + b0)/2;
      }else{
          b0  <- (b1 + b0)/2;
      }
      bynum   <- ((b1 + b0)/2 - b0) / 1000;
      TMvals1 <- seq(from = b0, to = (b1 + b0)/2, by = bynum);
      TMvals2 <- seq(from = (b1 + b0)/2, to = b1, by = bynum);
  }
  return((b1 + b0)/2);
}
```


```{r, echo = FALSE}
TMvals  <- seq(from = 0.00001, to = 1, by = 0.00001);
malefit <- W_m(mom = 1, mim = 1, mof = 1, mif = 1, M = 1, TF = 1, gamma = 1/2,
               a1 = 1/16, a2 = Inf, beta = 1, TM = TMvals);
TmOpt <- findWpmin(M = 1, beta = 1, gamma = 1/2, a1 = 1/16, b0 = 0, b1 = 10);
optMF <- W_m(mom = 1, mim = 1, mof = 1, mif = 1, M = 1, TF = 1, gamma = 1/2,
             a1 = 1/16, a2 = Inf, beta = 1, TM = TmOpt);
```

To model the evolution of nuptial gift giving from an ancestral state in which no nuptial gifts are provided, we first evaluate male fitness for an initial set of conditions. We assume that males first evolve optimal search time for nuptial gifts, then that females will evolve to accept or reject males without gifts. Evolved female choosiness can subsequently alter male fitness. We thereby simulate the evolution of male nuptial gift search and female choice. We do this first assuming that males do not search for fake nuptial gifts (setting $\alpha_{2} = \infty$ so $\Pr(F) = 0$), determining the dynamics of $T_{m}$ when only real nuptial gifts are provided before introducing fake nuptial gifts as an option for males.

For male fitness, given that the condition $\gamma > \alpha_{1}(M / \sqrt{\beta})$ is fulfilled, fitness will peak at some positive value of $T_{m}$. For illustration, we first select values $M = 1$, $\beta = 1$, $\alpha_{1} = 1/16$, and $\gamma = 1/2$. Under these conditions, we can find the value of $W_{m}$ across $T_{m}$ to determine its optimal value, $T^{*}_{m}$. Using a squeeze algorithm, we find $T^{*}_{m} = `r TmOpt`$, as indicated by the point in Figure 1.

```{r, echo = FALSE}
par(mar = c(5, 5, 1, 1));
plot(x = TMvals, y = malefit, type = "l", lwd = 2, cex.lab = 1.25,
     ylim = c(0, 1.5),
     xlab = expression(paste("Time out for males (", T[m], ")")),
     ylab = expression(paste("Male fitness (", W[m], ")")));
abline(h = 0, lty = "dotted", lwd = 0.8);
points(x = TmOpt, y = optMF, pch = 20, col = "black");
```



Given $T^{*}_{m} = `r TmOpt`$, we can now calculate $\Pr(G) = `r PrGf(Tm = TmOpt, a1 = 1/16)`$ and $\Pr(L) = `r PrLf(Tm = TmOpt, a1 = 1/16, a2 = Inf)`$. We can then feed these values into the equation for female fitness to determine if females should or should not be choosy. **[Note that I had forgotten about this attempt, but we might want to come back to a numerical treatment to complement the IBM?]**




Individual-based model
==============================

```{r, echo = FALSE}
male_evolve <- read.csv("results/sim_males_evolving.csv");
```

I have written an individual-based model that replicates the mathematical model above as closely as possible. This was time-consuming, and during the process I learned a lot about some subtleties of the assumptions that are being made. I will write up a full model description later, but for now, the simulation proceeds over multiple time steps. In each time step, a some number of interactions between randomly selected individuals in the mating pool occurs, and if one individual is male and the other is female, then there is the potential for mating. Females will always accepted males with gifts, but might reject males without gifts with some probability $R$. Whenever a male leaves the mating pool, he will search some number of time steps determined by poisson sampling with a rate parameter of $T_{M}$ (note, if this is zero, he can return to mate in the same time step), and may or may not get a nuptial gift. Whenever a female leaves the mating pool, the time she takes to process offspring is also determined by poisson sampling with a rate parameter of $T_{F}$ (again, if this is zero, she can return to the mating pool in the same time step). Standard techniques are used to keep the population at a carrying capacity.

A lot of my time has been spent trying to get the individual-based modelling results to match predictions of Figures 1 and 2 above. There were many times when the pattern was off and I realised that the IBM was not quite right. The most substantial and final error that I realised was that Figures 1 and 2 are not quite accurate for the long-term evolution predictions for several reasons. 

First, the line above which male searching should evolve ($T_{M} > 0$; zones B and D) reflects the *initial* evolution of male searching given no female choice (i.e., $R = 0$). If a bit of female choice has evolved, either due to selection or drift, then there is an additional selection pressure for males to search. Hence, the correct baseline for the IBM is a simulation in which female choice is not evolving, and all males are accepted as mates upon encounter. 

Second, the equations predicting the interaction rates are a bit inaccurate for the IBM. Recall that $M$ is the rate at which "an individual meets receptive mates" in a population of unbiased operational sex ratio [@Kokko2001]. Since $\beta$ represents the ratio of males to females (e.g., $\beta = 2$ means that there are twice as many males in the mating pool), we assume that males encounter females at a rate of $M / \sqrt{\beta}$ and females encounter males at a rate of $M \sqrt{\beta}$ [@Kokko2001]. To try to align the mathematical model and IBM as closely as possible, I was calculating an $M$ and $\beta$ from the simulations, but it is much more accurate to calculate the rate at which an average male in the mating pool meets a receptive female ($M_{male}$) and the rate at which an average female in the mating pool meets a receptive male ($M_{female}$). Because of the discrete nature of time steps (i.e., some individuals leave the mating pool mid time step), it is not always true that $M_{male} = M / \sqrt{\beta}$ or $M_{female} = M \sqrt{\beta}$, and this was causing small errors in the predictions for the evolution of searching. Below shows a plot of $M_{male}$ derived directly from the simulation versus calculated from simulation values of $M$ and $\beta$.

```{r, echo = FALSE}
Mm_directly   <- male_evolve$M_males;
Mm_calculated <- male_evolve$M_m / (sqrt(male_evolve$Beta));
plot(x = Mm_directly, y = Mm_calculated, pch = 20);
abline(a = 0, b = 1, col = "red", lwd = 2);
```

The red line shows a slope of 1 passing through the origin; if the IBM worked in perfect harmony with the maths, then all points should hit the line. We have the same story with $M_{female}$.

```{r, echo = FALSE}
Mf_directly   <- male_evolve$M_females;
Mf_calculated <- male_evolve$M_m * (sqrt(male_evolve$Beta));
plot(x = Mf_directly, y = Mf_calculated, pch = 20);
abline(a = 0, b = 1, col = "red", lwd = 2);
```

In short, the interaction rates calculated from $M$ and $\beta$ tend to overestimate the actual interaction rate for males and underestimate the interaction rate for females. The solution is therefore to just use $M_{male}$ and $M_{female}$ estimates directly from the IBM. Predicted threshold for evolution of searching is then simply,

$$\gamma_{m} > \lambda \alpha_{1} M_{males}$$

We can find this with a simple R function, where `Male_M` is $M_{males}$.

```{r}
male_IBM_criteria <- function(Male_M, alpha = 1, lambda = 1){
  return(lambda * alpha * Male_M);
}
```

For females, the predicted threshold for rejecting a male that does not have a gift is then,

$$\gamma_{f} > 1 - \lambda + \frac{e^{\frac{1}{\alpha_{1}}T_{M}}}{T_{F} M_{females}   \left(e^{\frac{1}{\alpha_{1}}T_{M}} - 1   \right)  }.$$

We can find this with another R function, where `Fem_M` is $M_{females}$.

```{r}
female_IBM_criteria <- function(Fem_M, TM = 1, alpha = 1, lambda = 1, TF = 2){
  topp <- exp(TM / alpha);
  bott <- TF * Fem_M * (exp(TM/alpha) - 1);
  gamF <- 1 - lambda + (topp / bott);
  return(gamF);
}
```

Once some of these issues were ironed out, I ran a simulation with the following parameter values.

| Parameter     | Value   | Description                                        |
|---------------|---------|----------------------------------------------------|
| $T_{m}$       | 0       | Evolving male search time                          |
| $T_{f}$       | 2       | Female processing time                             |
| $R$           | 0       | Female rejection rate                              |
| $\mu_{if}$    | 0.01    | Female mortality in mating pool                    |
| $\mu_{of}$    | 0.01    | Female mortality outside mating pool               |
| $\mu_{im}$    | 0.01    | Male mortality in mating pool                      |
| $\mu_{om}$    | 0.01    | Male mortality outside mating pool                 |
| $\lambda$     | 1       | Baseline female reproduction                       |
| $K$           | 1000    | Population carrying capacity                       |
| $\mu^{T_{m}}$ | 0.01    | Parent-offspring error of $T_{m}$                  |
| $\mu^{R}$     | 0.00    | Parent-offspring error of $R$                      |
| $t_{max}$     | 40000   | Total time steps                                   |

I ran the above parameter values across a range of $\gamma$ and $\alpha_{1}$ combinations, with each combination of $\gamma$ and $\alpha_{1}$ getting 20 replicates. From the calculated $M_{females}$ and $M_{males}$, Figure 3 below builds the zones of Figures 1 and 2.

```{r, echo = FALSE}
simpleboot <- function(freqs, repli = 1000, alpha = 0.05){  
  vals  <- NULL;                             
  i     <- 0;                                    
  while(i < repli){                             
    boot  <- sample(x = freqs, size = length(freqs), replace = TRUE);     
    strap <- mean(boot);                      
    vals  <- c(vals,strap);                     
    i     <- i + 1;                          
  }                                           
  vals   <- sort(x = vals, decreasing = FALSE);    
  lowCI  <- vals[round( (alpha * 0.5) * repli )];    
  highCI <- vals[round( (1-(alpha*0.5) ) * repli)];     
  CIs    <- c(lowCI, highCI);        
  return(CIs);         
}

res <- unique(cbind(male_evolve$a1, male_evolve$gam));

SUMM <- NULL;
for(i in 1:dim(res)[1]){
  a1_val  <- res[i, 1];
  gam_val <- res[i, 2];
  temp_r  <- which(male_evolve$a1 == a1_val & male_evolve$gam == gam_val);
  mean_Tm <- mean(male_evolve[temp_r,]$Tm);
  CIs_Tm  <- simpleboot(freqs = male_evolve[temp_r,]$Tm);
  mean_Rj <- mean(male_evolve[temp_r,]$RejPr);
  CIs_Rj  <- simpleboot(freqs = male_evolve[temp_r,]$RejPr);
  mean_Gf <- mean(male_evolve[temp_r,]$Gift);
  mean_Nu <- mean(male_evolve[temp_r,]$N_m);
  CIs_Nu  <- simpleboot(freqs = male_evolve[temp_r,]$N_m);
  mean_M  <- mean(male_evolve[temp_r,]$M_m);
  mean_B  <- mean(male_evolve[temp_r,]$Beta);
  mean_Mm <- mean(male_evolve[temp_r,]$M_males);
  mean_Fm <- mean(male_evolve[temp_r,]$M_females);
  
  new_row <- c(a1_val, gam_val, mean_Tm, CIs_Tm, mean_Rj, CIs_Rj, mean_Gf,
               mean_Nu, CIs_Nu, mean_M, mean_B, mean_Mm, mean_Fm);
  SUMM    <- rbind(SUMM, new_row);
}

colnames(SUMM) <- c("a1_val", "gam_val", "mean_TM", "LCI_Tm", "UCI_Tm",
                    "mean_Rj", "LCI_Rj", "UCI_Rj", "Gift", "Neutral",
                    "LCI_Neutral", "UCI_Neutral", "M", "Beta", "M_m", "F_m");

alpha_vals    <- seq(from = 0, to = 2.8, by = 0.2);
alpha_vals[1] <- 0.0001;

TM_vals      <- tapply(X = SUMM[,3],  INDEX = SUMM[,1], FUN = mean);
m_vals       <- tapply(X = SUMM[,13], INDEX = SUMM[,1], FUN = mean);
beta_vals    <- tapply(X = SUMM[,14], INDEX = SUMM[,1], FUN = mean);
Male_M       <- tapply(X = SUMM[,15], INDEX = SUMM[,1], FUN = mean);
Female_M     <- tapply(X = SUMM[,16], INDEX = SUMM[,1], FUN = mean);

g_m <- male_IBM_criteria(Male_M = Male_M, alpha = alpha_vals, lambda = 1);
g_f <- female_IBM_criteria(Fem_M = Female_M, TM = alpha_vals, 
                           alpha = alpha_vals, lambda = 1, TF = 2);

par(mar = c(5, 5, 1, 1)); 
plot(x = alpha_vals, y = g_m, type = "l", lwd = 2, cex.lab = 1.25,
     xlab = expression(paste("Nuptial gift search time (", alpha[1], ")")),
     ylab = expression(paste("Fitness threshold (", gamma, ")")),
     ylim = c(0, 2));
points(x = alpha_vals, y = g_f, type = "l", lwd = 2, cex.lab = 1.25,
       col = "black", lty = "solid");
g_v <- which(g_f > g_m);
g_w <- which(g_f <= g_m);
polygon(x = c(alpha_vals[g_v], rev(alpha_vals[g_v])), 
        y = c(g_m[g_v], rev(g_f[g_v])),
        border = NA, col = "grey70");
polygon(x = c(alpha_vals[g_w], rev(alpha_vals[g_w])), 
        y = c(g_m[g_w], rev(g_f[g_w])),
        border = NA, col = "grey20");
bott <- rep(0, times = length(alpha_vals));
topp <- c(g_m[g_v], g_f[g_w]);
polygon(x = c(alpha_vals, rev(alpha_vals)), 
        y = c(topp, rev(bott)),
        border = NA, col = "grey90");
points(x = alpha_vals, y = g_m, type = "l", lwd = 2, cex.lab = 1.25);
points(x = alpha_vals, y = g_f, type = "l", lwd = 2, cex.lab = 1.25);
for(i in 1:dim(SUMM)[1]){
  if(SUMM[i, 4] > 0 & SUMM[i, 5] > 0){
    points(x = SUMM[i, 1], y = SUMM[i, 2], cex = 1.5, col = "red", pch = 20);
  }
}
text(x = 0.15, y = 1.85, cex = 4, labels = "A");
text(x = 0.10, y = 0.4, cex = 2, labels = "B");
text(x = 2.55, y = 1.2, cex = 3, labels = "C", col = "white");
text(x = 2.55, y = 0.4, cex = 4, labels = "D");
```

The focus here is on the line with the highest slope, separating regions A and B from C and D (the horizontal line might need to be recalculated, more on this later). This is the line that determines whether searching should (above the line, zones A and B) or should not (below the line, zones C and D) evolve. The red points show areas of the parameter space in which searching has evolved in the IBM, as defined by the lower 95 percent confidence interval of the final $T_{m}$ being greater than zero. Aside for a small handful of points, the model appears quite accurate, and more replicates should improve the accuracy. 

Overall, these simulation results are highly encouraging, and my only regret is that it took so long to get them working. The next step is to look at things from the female perspective by fixing $T_{m} = \alpha_{1}$ for all males and letting female rejection rate evolve. We would then predict to see female rejection evolve for zones A and C, but not B and D. 

The natural final step is to then run everything with both male searching and female rejection evolving simultaneously. It might be good to flesh out the predictions from the numerical model first, but I might just be getting a bit too pedantic here?


References
======================















